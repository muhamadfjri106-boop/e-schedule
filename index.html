import React, { useState, useEffect } from 'react';
import { 
  Plus, Trash2, Clock, MapPin, Calendar, BookOpen, GraduationCap, 
  AlertCircle, Save, LogOut, User, Lock, Edit2, Brush, Users, 
  Bell, UserPlus, X, Sun, Moon 
} from 'lucide-react';

// --- DATA INITIALIZATION ---
const DEFAULT_USERS = [
  { id: 1, username: 'admin123', password: 'admin123', name: 'Administrator', role: 'admin' },
  { id: 2, username: 'user123', password: 'user123', name: 'Siswa', role: 'user' }
];

const INITIAL_PICKETS = [
  { day: 'Senin', students: 'Andi, Budi, Citra' },
  { day: 'Selasa', students: 'Dedi, Eka, Fani' },
  { day: 'Rabu', students: 'Gita, Hadi, Indah' },
  { day: 'Kamis', students: 'Joko, Kiki, Liana' },
  { day: 'Jumat', students: 'Mina, Nuri, Oki' },
];

export default function App() {
  // --- STATE: THEME ---
  const [isDarkMode, setIsDarkMode] = useState(false);

  // --- STATE: AUTH & USERS ---
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginError, setLoginError] = useState('');

  // --- STATE: MAIN APP ---
  const [activeTab, setActiveTab] = useState('schedule'); 
  const [schedules, setSchedules] = useState([]);
  const [pickets, setPickets] = useState([]);
  
  // --- STATE: NOTIFICATIONS ---
  const [notifications, setNotifications] = useState([]);
  const [showNotif, setShowNotif] = useState(false);

  // --- STATE: FORMS & UI ---
  const [formData, setFormData] = useState({
    subject: '', day: 'Senin', startTime: '', endTime: '', room: '', lecturer: '', type: 'Teori'
  });
  const [userFormData, setUserFormData] = useState({
    username: '', password: '', name: '', role: 'user'
  });
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState(null);
  const [activeDay, setActiveDay] = useState('Senin'); 
  const [showForm, setShowForm] = useState(false);
  
  // Edit Piket State
  const [editingPicketDay, setEditingPicketDay] = useState(null);
  const [picketInput, setPicketInput] = useState('');

  const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];

  // --- EFFECTS: LOAD & SAVE DATA ---
  
  // 1. Load Data on Mount
  useEffect(() => {
    // Load Users
    const savedUsers = localStorage.getItem('classPilotUsers');
    if (savedUsers) setUsers(JSON.parse(savedUsers));
    else setUsers(DEFAULT_USERS);

    // Load Schedules
    const savedSchedules = localStorage.getItem('classPilotData');
    if (savedSchedules) setSchedules(JSON.parse(savedSchedules));

    // Load Pickets
    const savedPickets = localStorage.getItem('classPilotPickets');
    if (savedPickets) setPickets(JSON.parse(savedPickets));
    else setPickets(INITIAL_PICKETS);

    // Load Theme
    const savedTheme = localStorage.getItem('classPilotTheme');
    if (savedTheme === 'dark') setIsDarkMode(true);

    // Set Active Day based on real day
    const todayIndex = new Date().getDay();
    const dayMap = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    let currentDay = dayMap[todayIndex];
    if (currentDay === 'Sabtu' || currentDay === 'Minggu') {
      currentDay = 'Senin';
    }
    setActiveDay(currentDay);
  }, []);

  // 2. Save Data on Change
  useEffect(() => {
    if (users.length > 0) localStorage.setItem('classPilotUsers', JSON.stringify(users));
  }, [users]);

  useEffect(() => {
    localStorage.setItem('classPilotData', JSON.stringify(schedules));
    checkUpcomingClasses(); 
  }, [schedules]);

  useEffect(() => {
    if (pickets.length > 0) localStorage.setItem('classPilotPickets', JSON.stringify(pickets));
  }, [pickets]);

  useEffect(() => {
    localStorage.setItem('classPilotTheme', isDarkMode ? 'dark' : 'light');
  }, [isDarkMode]);

  // 3. Notification Logic
  useEffect(() => {
    const interval = setInterval(checkUpcomingClasses, 60000);
    checkUpcomingClasses(); 
    return () => clearInterval(interval);
  }, [schedules]);

  const checkUpcomingClasses = () => {
    const now = new Date();
    const dayMap = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const currentDayName = dayMap[now.getDay()];
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentTimeVal = currentHour * 60 + currentMinute;

    const upcoming = schedules.filter(s => {
      if (s.day !== currentDayName) return false;
      const [h, m] = s.startTime.split(':').map(Number);
      const scheduleTimeVal = h * 60 + m;
      return scheduleTimeVal > currentTimeVal && scheduleTimeVal <= currentTimeVal + 60;
    });

    if (upcoming.length > 0) {
      setNotifications(upcoming.map(u => ({
        id: u.id,
        message: `Kelas ${u.subject} akan dimulai pukul ${u.startTime} di ${u.room}`,
        type: 'warning'
      })));
    } else {
      setNotifications([]);
    }
  };

  // --- AUTH LOGIC ---
  const handleLogin = (e) => {
    e.preventDefault();
    const foundUser = users.find(
      u => u.username === loginForm.username && u.password === loginForm.password
    );

    if (foundUser) {
      setCurrentUser(foundUser);
      setLoginError('');
    } else {
      setLoginError('Username atau password salah!');
    }
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setLoginForm({ username: '', password: '' });
    setActiveTab('schedule');
    setShowForm(false);
  };

  // --- SCHEDULE CRUD LOGIC ---
  const handleScheduleSubmit = (e) => {
    e.preventDefault();
    if (!formData.subject || !formData.startTime) return;

    if (isEditing) {
      setSchedules(prev => prev.map(item => item.id === editId ? { ...item, ...formData } : item));
      alert('Jadwal diperbarui!');
    } else {
      setSchedules(prev => [...prev, { id: Date.now(), ...formData }]);
    }
    
    setFormData({ subject: '', day: formData.day, startTime: '', endTime: '', room: '', lecturer: '', type: 'Teori' });
    setIsEditing(false);
    setEditId(null);
    setShowForm(false);
    setActiveDay(formData.day);
  };

  const handleDeleteSchedule = (id) => {
    if (window.confirm('Hapus jadwal ini?')) setSchedules(prev => prev.filter(item => item.id !== id));
  };

  const handleEditSchedule = (item) => {
    setFormData(item);
    setEditId(item.id);
    setIsEditing(true);
    setShowForm(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // --- PICKET LOGIC ---
  const handleEditPicket = (day, currentStudents) => {
    setEditingPicketDay(day);
    setPicketInput(currentStudents);
  };

  const savePicket = () => {
    setPickets(prev => prev.map(p => p.day === editingPicketDay ? { ...p, students: picketInput } : p));
    setEditingPicketDay(null);
  };

  // --- USER MANAGEMENT LOGIC ---
  const handleAddUser = (e) => {
    e.preventDefault();
    if (!userFormData.username || !userFormData.password) return;
    
    if (users.some(u => u.username === userFormData.username)) {
      alert('Username sudah digunakan!');
      return;
    }

    setUsers(prev => [...prev, { id: Date.now(), ...userFormData }]);
    setUserFormData({ username: '', password: '', name: '', role: 'user' });
    alert('User berhasil ditambahkan');
  };

  const handleDeleteUser = (id) => {
    if (id === currentUser.id) {
      alert("Tidak bisa menghapus akun sendiri!");
      return;
    }
    if (window.confirm('Hapus user ini?')) setUsers(prev => prev.filter(u => u.id !== id));
  };

  // --- HELPERS ---
  const filteredSchedules = schedules
    .filter(s => s.day === activeDay)
    .sort((a, b) => a.startTime.localeCompare(b.startTime));

  const getTypeColor = (type) => {
    switch (type) {
      case 'Praktikum': return 'bg-purple-100 text-purple-700 border-purple-200';
      case 'Responsi': return 'bg-orange-100 text-orange-700 border-orange-200';
      default: return 'bg-blue-100 text-blue-700 border-blue-200';
    }
  };

  // --- THEME CLASSES HELPERS ---
  const themeClasses = {
    bg: isDarkMode ? 'bg-gray-900' : 'bg-gray-50',
    text: isDarkMode ? 'text-gray-100' : 'text-gray-800',
    card: isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100',
    header: isDarkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-white shadow-sm',
    input: isDarkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400 focus:ring-indigo-400' : 'bg-white border-gray-300 focus:ring-indigo-500',
    subText: isDarkMode ? 'text-gray-400' : 'text-gray-500',
    heading: isDarkMode ? 'text-white' : 'text-gray-900',
    buttonGhost: isDarkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-500 hover:bg-gray-100',
    tabActive: isDarkMode ? 'border-indigo-400 text-indigo-400' : 'border-indigo-600 text-indigo-600',
    tabInactive: isDarkMode ? 'border-transparent text-gray-400 hover:text-gray-200' : 'border-transparent text-gray-500 hover:text-gray-700',
    dayActive: isDarkMode ? 'bg-indigo-600 text-white' : 'bg-gray-900 text-white',
    dayInactive: isDarkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700 border-gray-700' : 'bg-white text-gray-500 hover:bg-gray-100 border-gray-200',
  };

  // ----------------------------------------------------------------
  // RENDER: LOGIN PAGE
  // ----------------------------------------------------------------
  if (!currentUser) {
    return (
      <div className={`min-h-screen flex items-center justify-center p-4 font-sans transition-colors duration-300 ${themeClasses.bg}`}>
        <div className={`p-8 rounded-2xl shadow-xl w-full max-w-md border transition-colors duration-300 ${themeClasses.card}`}>
          {/* Theme Toggle on Login Page */}
          <div className="absolute top-4 right-4">
             <button 
              onClick={() => setIsDarkMode(!isDarkMode)} 
              className={`p-2 rounded-full transition-colors ${themeClasses.buttonGhost}`}
            >
              {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
            </button>
          </div>

          <div className="text-center mb-8">
            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg transform rotate-3">
              <Calendar className="w-8 h-8 text-white" />
            </div>
            <h1 className={`text-2xl font-bold ${themeClasses.heading}`}>ClassPilot Login</h1>
            <p className={`text-sm ${themeClasses.subText}`}>E-Schedule & Picket Manager</p>
          </div>

          <form onSubmit={handleLogin} className="space-y-4">
            {loginError && (
              <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2">
                <AlertCircle className="w-4 h-4" /> {loginError}
              </div>
            )}
            <div>
              <label className={`block text-sm font-medium mb-1 ${themeClasses.subText}`}>Username</label>
              <div className="relative">
                <User className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                <input type="text" value={loginForm.username} onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                  className={`w-full pl-10 p-3 border rounded-xl outline-none transition-colors ${themeClasses.input}`} placeholder="Username" />
              </div>
            </div>
            <div>
              <label className={`block text-sm font-medium mb-1 ${themeClasses.subText}`}>Password</label>
              <div className="relative">
                <Lock className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                <input type="password" value={loginForm.password} onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                  className={`w-full pl-10 p-3 border rounded-xl outline-none transition-colors ${themeClasses.input}`} placeholder="Password" />
              </div>
            </div>
            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-md">Masuk</button>
          </form>
          <div className={`mt-6 text-center text-xs p-4 rounded-lg ${isDarkMode ? 'bg-gray-900 text-gray-400' : 'bg-gray-50 text-gray-400'}`}>
            <p><strong>Default Admin:</strong> admin123 / admin123</p>
            <p><strong>Default User:</strong> user123 / user123</p>
          </div>
        </div>
      </div>
    );
  }

  // ----------------------------------------------------------------
  // RENDER: MAIN DASHBOARD
  // ----------------------------------------------------------------
  return (
    <div className={`min-h-screen font-sans pb-20 md:pb-0 transition-colors duration-300 ${themeClasses.bg} ${themeClasses.text}`}>
      
      {/* HEADER */}
      <header className={`sticky top-0 z-20 transition-colors duration-300 ${themeClasses.header}`}>
        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-indigo-600 p-2 rounded-lg">
              <Calendar className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className={`text-lg font-bold leading-none ${themeClasses.heading}`}>ClassPilot</h1>
              <span className={`text-xs ${themeClasses.subText}`}>{currentUser.name} ({currentUser.role})</span>
            </div>
          </div>
          
          <div className="flex items-center gap-1">
            {/* THEME TOGGLE */}
            <button 
              onClick={() => setIsDarkMode(!isDarkMode)} 
              className={`p-2 rounded-full ${themeClasses.buttonGhost}`}
              title={isDarkMode ? "Ganti ke Mode Terang" : "Ganti ke Mode Gelap"}
            >
              {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
            </button>

            {/* NOTIFICATION BELL */}
            <div className="relative">
              <button onClick={() => setShowNotif(!showNotif)} className={`p-2 rounded-full relative ${themeClasses.buttonGhost}`}>
                <Bell className="w-5 h-5" />
                {notifications.length > 0 && (
                  <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                )}
              </button>
              
              {/* Notif Dropdown */}
              {showNotif && (
                <div className={`absolute right-0 mt-2 w-72 rounded-xl shadow-xl border z-50 overflow-hidden ${themeClasses.card}`}>
                  <div className={`p-3 border-b flex justify-between items-center ${isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-100'}`}>
                    <h3 className={`text-sm font-bold ${themeClasses.heading}`}>Notifikasi</h3>
                    <button onClick={() => setShowNotif(false)}><X className={`w-4 h-4 ${themeClasses.subText}`}/></button>
                  </div>
                  <div className="max-h-64 overflow-y-auto">
                    {notifications.length === 0 ? (
                      <div className={`p-4 text-center text-xs ${themeClasses.subText}`}>Tidak ada notifikasi baru</div>
                    ) : (
                      notifications.map((n, idx) => (
                        <div key={idx} className={`p-3 border-b last:border-0 text-sm ${isDarkMode ? 'border-gray-700 hover:bg-gray-700' : 'border-gray-100 hover:bg-gray-50'}`}>
                          <p className={`font-medium ${themeClasses.heading}`}>{n.message}</p>
                          <span className="text-xs text-indigo-500 font-bold">Segera Dimulai</span>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}
            </div>

            <button onClick={handleLogout} className="p-2 text-red-400 hover:bg-red-50 rounded-full" title="Logout">
              <LogOut className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* NAVIGATION TABS */}
        <div className={`max-w-4xl mx-auto px-4 mt-2 flex gap-4 overflow-x-auto no-scrollbar border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-100'}`}>
          <button onClick={() => setActiveTab('schedule')} className={`pb-2 px-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 whitespace-nowrap ${activeTab === 'schedule' ? themeClasses.tabActive : themeClasses.tabInactive}`}>
            <BookOpen className="w-4 h-4" /> Jadwal Pelajaran
          </button>
          <button onClick={() => setActiveTab('picket')} className={`pb-2 px-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 whitespace-nowrap ${activeTab === 'picket' ? themeClasses.tabActive : themeClasses.tabInactive}`}>
            <Brush className="w-4 h-4" /> Jadwal Piket
          </button>
          {currentUser.role === 'admin' && (
            <button onClick={() => setActiveTab('users')} className={`pb-2 px-2 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 whitespace-nowrap ${activeTab === 'users' ? themeClasses.tabActive : themeClasses.tabInactive}`}>
              <Users className="w-4 h-4" /> Kelola User
            </button>
          )}
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-6">
        
        {/* === TAB 1: JADWAL PELAJARAN === */}
        {activeTab === 'schedule' && (
          <>
            {/* Day Selector */}
            <div className="flex overflow-x-auto pb-4 gap-2 mb-4 no-scrollbar">
              {days.map(day => (
                <button key={day} onClick={() => setActiveDay(day)}
                  className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all border ${activeDay === day ? themeClasses.dayActive : themeClasses.dayInactive}`}>
                  {day}
                </button>
              ))}
            </div>

            {/* Add Button (Admin) */}
            {currentUser.role === 'admin' && (
               <div className="mb-4 flex justify-end">
                 <button onClick={() => { if(showForm && isEditing) setFormData({ subject: '', day: 'Senin', startTime: '', endTime: '', room: '', lecturer: '', type: 'Teori' }); setShowForm(!showForm); setIsEditing(false); }} 
                   className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow hover:bg-indigo-700 transition">
                   <Plus className={`w-4 h-4 ${showForm ? 'rotate-45' : ''} transition`} /> {showForm ? 'Tutup Form' : 'Tambah Jadwal'}
                 </button>
               </div>
            )}

            {/* FORM INPUT JADWAL */}
            {showForm && currentUser.role === 'admin' && (
              <div className={`p-6 rounded-2xl shadow-lg border mb-6 animate-fade-in-down ${themeClasses.card}`}>
                <form onSubmit={handleScheduleSubmit} className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Mata Pelajaran</label>
                      <input type="text" value={formData.subject} onChange={(e) => setFormData({...formData, subject: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`} placeholder="Contoh: Matematika" required />
                    </div>
                    <div>
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Guru</label>
                      <input type="text" value={formData.lecturer} onChange={(e) => setFormData({...formData, lecturer: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`} placeholder="Nama Guru" />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="col-span-2 md:col-span-1">
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Hari</label>
                      <select value={formData.day} onChange={(e) => setFormData({...formData, day: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`}>{days.map(d => <option key={d} value={d} className="text-gray-900">{d}</option>)}</select>
                    </div>
                    <div>
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Mulai</label>
                      <input type="time" value={formData.startTime} onChange={(e) => setFormData({...formData, startTime: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`} required />
                    </div>
                    <div>
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Selesai</label>
                      <input type="time" value={formData.endTime} onChange={(e) => setFormData({...formData, endTime: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`} required />
                    </div>
                    <div>
                      <label className={`block text-xs font-bold uppercase mb-1 ${themeClasses.subText}`}>Ruang</label>
                      <input type="text" value={formData.room} onChange={(e) => setFormData({...formData, room: e.target.value})} className={`w-full p-2 border rounded-lg ${themeClasses.input}`} placeholder="R.101" />
                    </div>
                  </div>
                  <button type="submit" className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700">{isEditing ? 'Simpan Perubahan' : 'Tambah Jadwal'}</button>
                </form>
              </div>
            )}

            {/* LIST JADWAL */}
            <div className="space-y-3">
              {filteredSchedules.length === 0 ? (
                <div className={`text-center py-10 rounded-xl border border-dashed ${isDarkMode ? 'border-gray-700 bg-gray-800 text-gray-400' : 'border-gray-200 bg-white text-gray-400'}`}>Belum ada jadwal hari ini.</div>
              ) : (
                filteredSchedules.map(schedule => (
                  <div key={schedule.id} className={`p-4 rounded-xl shadow-sm border relative overflow-hidden flex gap-4 ${themeClasses.card}`}>
                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${getTypeColor(schedule.type).replace('bg-', 'bg-').split(' ')[0]}`}></div>
                    
                    <div className={`flex flex-col items-center justify-center min-w-[80px] border-r pr-4 ${isDarkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                      <span className={`text-lg font-bold ${themeClasses.heading}`}>{schedule.startTime}</span>
                      <span className={`text-xs ${themeClasses.subText}`}>{schedule.endTime}</span>
                    </div>

                    <div className="flex-1">
                      <div className="flex justify-between items-start">
                        <div>
                          <span className={`text-[10px] px-2 py-0.5 rounded border ${getTypeColor(schedule.type)}`}>{schedule.type}</span>
                          <h3 className={`font-bold text-lg mt-1 ${themeClasses.heading}`}>{schedule.subject}</h3>
                        </div>
                        {currentUser.role === 'admin' && (
                          <div className="flex gap-1">
                            <button onClick={() => handleEditSchedule(schedule)} className={`p-1.5 rounded-lg ${isDarkMode ? 'text-blue-400 bg-blue-900/30' : 'text-blue-500 bg-blue-50 hover:bg-blue-100'}`}><Edit2 className="w-4 h-4"/></button>
                            <button onClick={() => handleDeleteSchedule(schedule.id)} className={`p-1.5 rounded-lg ${isDarkMode ? 'text-red-400 bg-red-900/30' : 'text-red-500 bg-red-50 hover:bg-red-100'}`}><Trash2 className="w-4 h-4"/></button>
                          </div>
                        )}
                      </div>
                      <div className={`mt-1 flex gap-3 text-sm ${themeClasses.subText}`}>
                        {schedule.lecturer && <span className="flex items-center gap-1"><GraduationCap className="w-3 h-3"/> {schedule.lecturer}</span>}
                        {schedule.room && <span className="flex items-center gap-1"><MapPin className="w-3 h-3"/> {schedule.room}</span>}
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </>
        )}

        {/* === TAB 2: JADWAL PIKET === */}
        {activeTab === 'picket' && (
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {pickets.map((picket, index) => (
              <div key={index} className={`p-5 rounded-xl shadow-sm border ${themeClasses.card}`}>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-bold text-indigo-500 text-lg flex items-center gap-2">
                    <Calendar className="w-4 h-4"/> {picket.day}
                  </h3>
                  {currentUser.role === 'admin' && editingPicketDay !== picket.day && (
                    <button onClick={() => handleEditPicket(picket.day, picket.students)} className={`text-xs flex items-center gap-1 ${isDarkMode ? 'text-gray-400 hover:text-indigo-400' : 'text-gray-400 hover:text-indigo-600'}`}>
                      <Edit2 className="w-3 h-3"/> Edit
                    </button>
                  )}
                </div>

                {editingPicketDay === picket.day ? (
                  <div className="space-y-2">
                    <textarea 
                      value={picketInput} 
                      onChange={(e) => setPicketInput(e.target.value)}
                      className={`w-full p-2 border rounded-lg text-sm outline-none ${themeClasses.input}`}
                      rows="3"
                    ></textarea>
                    <div className="flex gap-2 justify-end">
                      <button onClick={() => setEditingPicketDay(null)} className={`px-3 py-1 text-xs ${themeClasses.subText}`}>Batal</button>
                      <button onClick={savePicket} className="px-3 py-1 text-xs bg-indigo-600 text-white rounded">Simpan</button>
                    </div>
                  </div>
                ) : (
                  <div className={`p-3 rounded-lg border ${isDarkMode ? 'bg-yellow-900/20 border-yellow-800 text-yellow-100' : 'bg-yellow-50 border-yellow-100 text-gray-700'}`}>
                    <p className="text-sm leading-relaxed font-medium">
                      {picket.students || "Belum ada data piket"}
                    </p>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {/* === TAB 3: KELOLA USER (ADMIN ONLY) === */}
        {activeTab === 'users' && currentUser.role === 'admin' && (
          <div className="space-y-6">
            {/* Form Tambah User */}
            <div className={`p-5 rounded-xl shadow-sm border ${themeClasses.card}`}>
              <h3 className={`font-bold mb-4 flex items-center gap-2 ${themeClasses.heading}`}><UserPlus className="w-5 h-5 text-indigo-600"/> Tambah User Baru</h3>
              <form onSubmit={handleAddUser} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Nama Lengkap" value={userFormData.name} onChange={e => setUserFormData({...userFormData, name: e.target.value})} className={`p-2 border rounded-lg text-sm ${themeClasses.input}`} required/>
                <select value={userFormData.role} onChange={e => setUserFormData({...userFormData, role: e.target.value})} className={`p-2 border rounded-lg text-sm ${themeClasses.input}`}>
                  <option value="user" className="text-gray-900">Siswa (User)</option>
                  <option value="admin" className="text-gray-900">Admin</option>
                </select>
                <input type="text" placeholder="Username" value={userFormData.username} onChange={e => setUserFormData({...userFormData, username: e.target.value})} className={`p-2 border rounded-lg text-sm ${themeClasses.input}`} required/>
                <input type="text" placeholder="Password" value={userFormData.password} onChange={e => setUserFormData({...userFormData, password: e.target.value})} className={`p-2 border rounded-lg text-sm ${themeClasses.input}`} required/>
                <div className="md:col-span-2">
                  <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold w-full hover:bg-indigo-700">Tambah User</button>
                </div>
              </form>
            </div>

            {/* List User */}
            <div className={`rounded-xl shadow-sm border overflow-hidden ${themeClasses.card}`}>
              <table className="w-full text-sm text-left">
                <thead className={`uppercase font-bold text-xs ${isDarkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-50 text-gray-500'}`}>
                  <tr>
                    <th className="p-4">Nama</th>
                    <th className="p-4">Role</th>
                    <th className="p-4">Username</th>
                    <th className="p-4 text-right">Aksi</th>
                  </tr>
                </thead>
                <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-100'}`}>
                  {users.map(user => (
                    <tr key={user.id} className={`${isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}`}>
                      <td className={`p-4 font-medium ${themeClasses.heading}`}>{user.name}</td>
                      <td className="p-4">
                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${user.role === 'admin' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                          {user.role}
                        </span>
                      </td>
                      <td className={`p-4 ${themeClasses.subText}`}>{user.username}</td>
                      <td className="p-4 text-right">
                        {user.id !== currentUser.id && (
                          <button onClick={() => handleDeleteUser(user.id)} className="text-red-400 hover:text-red-600">
                            <Trash2 className="w-4 h-4"/>
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
